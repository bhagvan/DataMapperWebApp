<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Data Mapper</title>
    <link rel="stylesheet" href="assets/lib/bootstrap_v3.3.6/css/bootstrap.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/context-menu.css">
    <link rel="stylesheet" href="assets/css/diagram-tool-bar.css">

    <script src="assets/lib/d3_v4.2.2/d3.js"></script>
    <script src="assets/lib/jQuery_v3.1.0/jquery-3.1.0.js"></script>
    <script src="assets/lib/jquery-ui_v1.12.0/jquery-ui.js"></script>
    <script src="assets/lib/underscore_v1.83/underscore_1.8.3.js" type="text/javascript"></script>
    <script src="assets/lib/backbone_v1.3.3/backbone_1.3.3.js" type="text/javascript"></script>
    <script src="assets/fileHandler.js"></script>

</head>

<body>


<div id="page-content" class="container" style="width:100vw;">
    <!--<div class="row">-->
    <!--<div id="op-panel">-->
    <!--<button id="concat-op-btn">Add concat operator <br> 2 to 1</button>-->
    <!--<button id="split-op-btn">Add split operator <br> 1 to 3</button>-->
    <!--</div>-->
    <!--</div>-->
    <div class="row">
        <div id="tool-palette" style="background: #232323;" class="col-md-2"></div>
        <div id="canvas-container" class="col-md-10">
            <svg id="canvas" class="canvas" width="1500" height="500">

            </svg>

        </div>
    </div>
    <!--<div class="row">-->
    <!--<button onclick="showMappings()">showMappings</button>-->
    <!--</div>-->
    <div id="right-click-menu">
        <!--<input type="file" class="schema-select input-schema-select"  name="input-select[]"-->
               <!--accept="application/json"/>-->
        <!--<input type="file" class="schema-select output-schema-select"  name="input-select[]"-->
               <!--accept="application/json"/>-->
        <ul class='custom-menu dropdown-menu' id="dmcontainer-menu">
            <li data-action="load">Load Schema</li>
            <li data-action="clear">Clear container</li>
        </ul>
    </div>
</div>


<script>

    var DataMapper = {
        //the editor = svg
        Canvas: d3.select("#canvas"),
        //a Backbone collection of all the operators in the app
        Operators: {},
        // Backbone view corresponding to Input/Output container
        // the model contains the loaded schema as a JSON object and a collection of nodes
        InputView: {},
        OutputView: {},
        //all the 'lines' drawn in the application
        //each connector contains information on sourceNode, targetNode, sourceContainer, targetContainer and the d3 line object
        Connectors: {},
        PalleteView: {},

        //Definitions
        Models: {},
        Collections: {},
        Views: {}
    };
</script>
<script src="assets/js/views.js"></script>
<script src="assets/js/models.js"></script>
<script src="assets/js/collections.js"></script>
<script src="assets/js/tool-palette/tool-view.js"></script>
<script src="assets/js/tool-palette/tool.js"></script>
<script src="assets/js/tool-palette/toolgroup-view.js"></script>
<script src="assets/js/tool-palette/toolgroup.js"></script>
<script src="assets/js/tool-palette/toolpalette-view.js"></script>
<script src="assets/js/tool-palette/toolpalette.js"></script>
<script src="assets/js/tool-palette/definitions/tools-init.js"></script>
<script>
    function showMappings() {
        var variableList = [], count = 0,
                nodeList = new DataMapper.Collections.NodeList(),
                inputAdjList = [],
                outputAdjList = [];
        [DataMapper.InputView.model, DataMapper.OutputView.model].map(function (model) {
            model.get('nodeCollection').models.map(function (node) {
                variableList.push({id: count, text: model.getPath(node.get('text')), type: node.get('textType')});
                node.set('id', count);
                nodeList.add(node);
                count++;
            });
        });
        DataMapper.Operators.models.map(function (model) {
            model.get('nodeCollection').models.map(function (node) {
                variableList.push({id: count, text: node.get('text'), type: node.get('textType')});
                node.set('id', count);
                count++;
                nodeList.add(node);
            });
        });
        DataMapper.Operators.models.map(function (model) {
            var inputs = [], outputs = [];
            model.get('nodeCollection').models.map(function (node) {
                var type = node.get('type');
                if (type === "output") {
                    var connector = DataMapper.Connectors.findFromTarget(node.get('node')) || null;
                    if (connector !== null) {
                        var opposite = connector.get('sourceNode'); //d3 node object
                        var oppositeNode = nodeList.getNodeFromDOMObject(opposite.node()); //backbone model
                        inputs.push([oppositeNode.get('id')]);
                    } else {
                        inputs.push([]);
                    }
                } else if (type === "input") {
                    var connectors = DataMapper.Connectors.findFromSource(node.get('node'));
                    var targets = [];
                    if (connectors.length > 0) {
                        connectors.map(function (connector) {
                            var opposite = connector.get('targetNode'); //d3 node object
                            var oppositeNode = nodeList.getNodeFromDOMObject(opposite.node()); //backbone model
                            targets.push(oppositeNode.get('id'));
                        });
                    }
                    outputs.push(targets);
                }
            });
            inputAdjList.push({operator: model, inputs: inputs});
            outputAdjList.push({operator: model, outputs: outputs});
        });
        console.log("variable list:");
        console.log(variableList);
        console.log("operators:");
        console.log(DataMapper.Operators.models);
        console.log("input adjacency list:");
        console.log(inputAdjList);
        console.log("output adjacency list:");
        console.log(outputAdjList);
//                console.log(DataMapper.Connectors.getMappings());
    }

    new DataMapper.Views.CanvasView();


</script>


</body>

</html>