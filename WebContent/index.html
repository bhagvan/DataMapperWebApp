<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Data Mapper</title>
    <script src="assets/lib/d3/d3.js"></script>
    <script src="assets/lib/jQuery/jquery-3.1.0.js"></script>

    <script src="assets/lib/jquery-ui-1.12.0.custom/jquery-ui.js"></script>

    <script src="assets/lib/underscore/underscore_1.8.3.js" type="text/javascript"></script>
    <script src="assets/lib/backbone/backbone_1.3.3.js" type="text/javascript"></script>
    <script src="assets/fileHandler.js"></script>
    <link rel="stylesheet" href="assets/style.css">


</head>

<body>


<div id="file-load">
    <div class="file-load-container" id="input-file-load-container">
        <button id="load-input-btn">Load input</button>
        <button id="clear-input-btn">Clear input</button>

        <div class="load-file" id="load-input">
            <input type="file" class="file-select input" id="input-file-select" name="input-select[]"
                   accept="application/json"/>
            <div class="file-drag input" id="input-file-drag">or drop files here</div>
        </div>

    </div>

    <div class="file-load-container" id="output-file-load-container">
        <button id="load-output-btn">Load output</button>
        <button id="clear-output-btn">Clear output</button>

        <div class="load-file" id="load-output">
            <input type="file" class="file-select output" id="output-file-select" name="output-select[]"
                   accept=".json"/>
            <div class="file-drag output" id="output-file-drag">or drop files here</div>
        </div>

    </div>
</div>

<div id="op-panel">
    <button id="concat-op-btn">Add concat operator <br> 2 to 1</button>
    <button id="split-op-btn">Add split operator <br> 1 to 3</button>
</div>

<div id="canvas-container">
    <svg id="canvas" class="canvas" width="1800" height="500">
        <g id="input-container" transform="translate(40,40)" class="tree-container container">

            <g id="input-container-fo" class="container-fo">
                <rect class="container-title-outline" id="input-container-title-outline" height="20" fill="#D3DA7B"
                      stroke="black"></rect>
                <text class="container-title" id="input-container-title" font-weight="bold">Input</text>
                <rect class="container-outline" id="input-container-outline" height="10" fill="none"
                      stroke="black"></rect>
            </g>
        </g>


        <g id="output-container" transform="translate(1300,40)" class="tree-container container">
            <g id="output-container-fo" class="container-fo">
                <rect class="container-title-outline" id="output-container-title-outline" height="20" fill="#FCE0D3"
                      stroke="black"></rect>
                <text class="container-title" id="output-container-title" font-weight="bold">Output</text>
                <rect class="container-outline" id="output-container-outline" height="10" fill="none"
                      stroke="black"></rect>
            </g>

        </g>

    </svg>

</div>
<button onclick="showMappings()">showMappings</button>


<script>

    var DataMapper = {
        Canvas: d3.select("#canvas"),
        Operators: {},
        InputView: {},
        OutputView: {},
        Connectors: {}, //  4 possible maps are:input to op - 0,op to output - 1,op to op - 2,input to output - 3
        Mappings: [],
        //for namespace purposes------
        Models: {},
        Collections: {},
        Views: {},
        Templates: {}
    };
</script>
<script src="assets/js/views.js"></script>
<script src="assets/js/models.js"></script>
<script src="assets/js/collections.js"></script>
<script>
    function showMappings() {
        var variableList = [], count = 0,
                nodeList = new DataMapper.Collections.NodeList(),
                inputAdjList = [],
                outputAdjList = [];
        [DataMapper.InputView.model, DataMapper.OutputView.model].map(function (model) {
            model.get('nodeCollection').models.map(function (node) {
                variableList.push({id: count, text: model.getPath(node.get('text')), type: node.get('textType')});
                node.set('id', count);
                nodeList.add(node);
                count++;
            });
        });
        DataMapper.Operators.models.map(function (model) {
            model.get('nodeCollection').models.map(function (node) {
                variableList.push({id: count, text: node.get('text'), type: node.get('textType')});
                node.set('id', count);
                count++;
                nodeList.add(node);
            });
        });
        DataMapper.Operators.models.map(function (model) {
            var inputs = [], outputs = [];
            model.get('nodeCollection').models.map(function (node) {
                var type = node.get('type');
                if (type === "output") {
                    var connector = DataMapper.Connectors.findFromTarget(node.get('node')) || null;
                    if (connector !== null) {
                        var opposite = connector.get('sourceNode'); //d3 node object
                        var oppositeNode = nodeList.getNodeFromDOMObject(opposite.node()); //backbone model
                        inputs.push([oppositeNode.get('id')]);
                    } else {
                        inputs.push([]);
                    }
                } else if (type === "input") {
                    var connectors = DataMapper.Connectors.findFromSource(node.get('node'));
                    var targets = [];
                    if (connectors.length > 0) {
                        connectors.map(function (connector) {
                            var opposite = connector.get('targetNode'); //d3 node object
                            var oppositeNode = nodeList.getNodeFromDOMObject(opposite.node()); //backbone model
                            targets.push(oppositeNode.get('id'));
                        });
                    }
                    outputs.push(targets);
                }
            });
            inputAdjList.push({operator: model, inputs: inputs});
            outputAdjList.push({operator: model, outputs: outputs});
        });
        console.log("variable list:");
        console.log(variableList);
        console.log("operators:");
        console.log(DataMapper.Operators.models);
        console.log("input adjacency list:");
        console.log(inputAdjList);
        console.log("output adjacency list:");
        console.log(outputAdjList);
//                console.log(DataMapper.Connectors.getMappings());
    }

    new DataMapper.Views.CanvasView();


</script>


</body>

</html>